name: Deploy to GCE

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  VM_ZONE: us-central1-a
  VM_NAME: cinema-scheduler
  GCS_BUCKET: cinema-scheduler-${{ vars.GCP_PROJECT_ID }}

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Build and Deploy to GCE
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Create deployment artifact
        run: |
          tar -czf deploy.tar.gz \
            packages/shared/dist \
            packages/mcp/dist \
            packages/scraper/dist \
            packages/cron/dist \
            packages/scraper/config \
            packages/cron/config \
            infra/scripts

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Upload artifact to GCS
        run: gsutil cp deploy.tar.gz gs://${{ env.GCS_BUCKET }}/deploy.tar.gz

      - name: Deploy to VM
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.VM_ZONE }} \
            --project=${{ env.PROJECT_ID }} \
            --tunnel-through-iap \
            --command="sudo -u cinema-scheduler bash /opt/cinema-scheduler/infra/scripts/deploy.sh"
