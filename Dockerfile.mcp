# Stage 1: Build
FROM node:20-slim AS builder

RUN corepack enable && corepack prepare pnpm@9.15.4 --activate

WORKDIR /app

# 依存関係のインストール（キャッシュ効率化のためソースより先に）
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json turbo.json ./
COPY packages/shared/package.json packages/shared/
COPY packages/mcp/package.json packages/mcp/

RUN pnpm install --frozen-lockfile

# ソースコピー＆ビルド
COPY packages/shared/ packages/shared/
COPY packages/mcp/ packages/mcp/
COPY tsconfig.base.json ./

RUN pnpm --filter @cinema-scheduler/shared run build && \
    pnpm --filter @cinema-scheduler/mcp run build

# 本番依存のみ再インストール
RUN pnpm install --frozen-lockfile --prod

# Stage 2: Runtime
FROM node:20-slim

WORKDIR /app

# 必要なファイルのみコピー
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/packages/shared/dist ./packages/shared/dist
COPY --from=builder /app/packages/shared/package.json ./packages/shared/
COPY --from=builder /app/packages/shared/node_modules ./packages/shared/node_modules
COPY --from=builder /app/packages/mcp/dist ./packages/mcp/dist
COPY --from=builder /app/packages/mcp/package.json ./packages/mcp/
COPY --from=builder /app/packages/mcp/node_modules ./packages/mcp/node_modules
COPY --from=builder /app/package.json ./

ENV PORT=8080
ENV NODE_ENV=production

EXPOSE 8080

USER node

CMD ["node", "packages/mcp/dist/handler.js"]
